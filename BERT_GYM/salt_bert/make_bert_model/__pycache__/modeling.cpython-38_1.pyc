54.0000000newline='\n'31.0000000newline='\n'21.0000000newline='\n'25.0000000newline='\n'14.0000000newline='\n'18.0000000newline='\n'20.0000000newline='\n'27.0000000newline='\n'63.0000000newline='\n'91.0000000newline='\n'123.0000000newline='\n'143.0000000newline='\n'150.0000000newline='\n'169.0000000newline='\n'161.0000000newline='\n'165.0000000newline='\n'137.0000000newline='\n'153.0000000newline='\n'138.0000000newline='\n'116.0000000newline='\n'103.0000000newline='\n'107.0000000newline='\n'109.0000000newline='\n'78.0000000
53.0000000newline='\n'35.0000000newline='\n'23.0000000newline='\n'15.0000000newline='\n'10.0000000newline='\n'8.0000000newline='\n'16.0000000newline='\n'15.0000000newline='\n'31.0000000newline='\n'61.0000000newline='\n'75.0000000newline='\n'86.0000000newline='\n'93.0000000newline='\n'98.0000000newline='\n'104.0000000newline='\n'121.0000000newline='\n'124.0000000newline='\n'112.0000000newline='\n'114.0000000newline='\n'109.0000000newline='\n'108.0000000newline='\n'83.0000000newline='\n'77.0000000newline='\n'50.0000000
28.0000000newline='\n'23.0000000newline='\n'12.0000000newline='\n'15.0000000newline='\n'12.0000000newline='\n'13.0000000newline='\n'16.0000000newline='\n'23.0000000newline='\n'56.0000000newline='\n'69.0000000newline='\n'100.0000000newline='\n'90.0000000newline='\n'85.0000000newline='\n'104.0000000newline='\n'84.0000000newline='\n'104.0000000newline='\n'92.0000000newline='\n'97.0000000newline='\n'86.0000000newline='\n'88.0000000newline='\n'82.0000000newline='\n'59.0000000newline='\n'72.0000000newline='\n'47.0000000
45.0000000newline='\n'29.0000000newline='\n'21.0000000newline='\n'13.0000000newline='\n'13.0000000newline='\n'15.0000000newline='\n'20.0000000newline='\n'29.0000000newline='\n'58.0000000newline='\n'96.0000000newline='\n'121.0000000newline='\n'108.0000000newline='\n'109.0000000newline='\n'116.0000000newline='\n'116.0000000newline='\n'132.0000000newline='\n'127.0000000newline='\n'125.0000000newline='\n'109.0000000newline='\n'96.0000000newline='\n'88.0000000newline='\n'93.0000000newline='\n'80.0000000newline='\n'67.0000000
45.0000000newline='\n'27.0000000newline='\n'26.0000000newline='\n'16.0000000newline='\n'11.0000000newline='\n'11.0000000newline='\n'17.0000000newline='\n'25.0000000newline='\n'56.0000000newline='\n'88.0000000newline='\n'101.0000000newline='\n'108.0000000newline='\n'104.0000000newline='\n'112.0000000newline='\n'114.0000000newline='\n'115.0000000newline='\n'147.0000000newline='\n'118.0000000newline='\n'130.0000000newline='\n'97.0000000newline='\n'101.0000000newline='\n'93.0000000newline='\n'84.0000000newline='\n'75.0000000
73.0000000newline='\n'57.0000000newline='\n'33.0000000newline='\n'23.0000000newline='\n'19.0000000newline='\n'21.0000000newline='\n'23.0000000newline='\n'36.0000000newline='\n'67.0000000newline='\n'113.0000000newline='\n'128.0000000newline='\n'127.0000000newline='\n'135.0000000newline='\n'158.0000000newline='\n'155.0000000newline='\n'145.0000000newline='\n'172.0000000newline='\n'168.0000000newline='\n'139.0000000newline='\n'124.0000000newline='\n'100.0000000newline='\n'99.0000000newline='\n'114.0000000newline='\n'70.0000000
58.0000000newline='\n'38.0000000newline='\n'21.0000000newline='\n'15.0000000newline='\n'17.0000000newline='\n'16.0000000newline='\n'21.0000000newline='\n'26.0000000newline='\n'63.0000000newline='\n'104.0000000newline='\n'128.0000000newline='\n'127.0000000newline='\n'127.0000000newline='\n'140.0000000newline='\n'144.0000000newline='\n'167.0000000newline='\n'147.0000000newline='\n'146.0000000newline='\n'137.0000000newline='\n'110.0000000newline='\n'105.0000000newline='\n'110.0000000newline='\n'93.0000000newline='\n'74.0000000
45.0000000newline='\n'30.0000000newline='\n'31.0000000newline='\n'20.0000000newline='\n'16.0000000newline='\n'13.0000000newline='\n'20.0000000newline='\n'28.0000000newline='\n'56.0000000newline='\n'91.0000000newline='\n'96.0000000newline='\n'120.0000000newline='\n'113.0000000newline='\n'111.0000000newline='\n'122.0000000newline='\n'134.0000000newline='\n'155.0000000newline='\n'129.0000000newline='\n'148.0000000newline='\n'131.0000000newline='\n'130.0000000newline='\n'112.0000000newline='\n'93.0000000newline='\n'75.0000000
81.0000000newline='\n'43.0000000newline='\n'34.0000000newline='\n'25.0000000newline='\n'18.0000000newline='\n'15.0000000newline='\n'22.0000000newline='\n'28.0000000newline='\n'48.0000000newline='\n'64.0000000newline='\n'110.0000000newline='\n'130.0000000newline='\n'153.0000000newline='\n'142.0000000newline='\n'151.0000000newline='\n'149.0000000newline='\n'145.0000000newline='\n'151.0000000newline='\n'143.0000000newline='\n'148.0000000newline='\n'135.0000000newline='\n'111.0000000newline='\n'99.0000000newline='\n'82.0000000
51.0000000newline='\n'35.0000000newline='\n'23.0000000newline='\n'17.0000000newline='\n'15.0000000newline='\n'17.0000000newline='\n'20.0000000newline='\n'27.0000000newline='\n'66.0000000newline='\n'97.0000000newline='\n'112.0000000newline='\n'113.0000000newline='\n'105.0000000newline='\n'110.0000000newline='\n'131.0000000newline='\n'112.0000000newline='\n'142.0000000newline='\n'137.0000000newline='\n'109.0000000newline='\n'100.0000000newline='\n'90.0000000newline='\n'80.0000000newline='\n'80.0000000newline='\n'72.0000000
48.0000000newline='\n'32.0000000newline='\n'20.0000000newline='\n'17.0000000newline='\n'13.0000000newline='\n'13.0000000newline='\n'18.0000000newline='\n'27.0000000newline='\n'61.0000000newline='\n'108.0000000newline='\n'120.0000000newline='\n'123.0000000newline='\n'125.0000000newline='\n'136.0000000newline='\n'120.0000000newline='\n'140.0000000newline='\n'132.0000000newline='\n'141.0000000newline='\n'120.0000000newline='\n'94.0000000newline='\n'84.0000000newline='\n'95.0000000newline='\n'87.0000000newline='\n'74.0000000
43.0000000newline='\n'31.0000000newline='\n'26.0000000newline='\n'17.0000000newline='\n'13.0000000newline='\n'15.0000000newline='\n'22.0000000newline='\n'32.0000000newline='\n'58.0000000newline='\n'99.0000000newline='\n'117.0000000newline='\n'111.0000000newline='\n'123.0000000newline='\n'118.0000000newline='\n'126.0000000newline='\n'147.0000000newline='\n'148.0000000newline='\n'141.0000000newline='\n'136.0000000newline='\n'114.0000000newline='\n'102.0000000newline='\n'105.0000000newline='\n'82.0000000newline='\n'78.0000000
60.0000000newline='\n'33.0000000newline='\n'20.0000000newline='\n'22.0000000newline='\n'18.0000000newline='\n'14.0000000newline='\n'23.0000000newline='\n'39.0000000newline='\n'70.0000000newline='\n'129.0000000newline='\n'151.0000000newline='\n'148.0000000newline='\n'123.0000000newline='\n'165.0000000newline='\n'148.0000000newline='\n'155.0000000newline='\n'166.0000000newline='\n'159.0000000newline='\n'126.0000000newline='\n'112.0000000newline='\n'90.0000000newline='\n'90.0000000newline='\n'85.0000000newline='\n'72.0000000
51.0000000newline='\n'31.0000000newline='\n'25.0000000newline='\n'16.0000000newline='\n'12.0000000newline='\n'10.0000000newline='\n'18.0000000newline='\n'28.0000000newline='\n'57.0000000newline='\n'94.0000000newline='\n'110.0000000newline='\n'106.0000000newline='\n'118.0000000newline='\n'121.0000000newline='\n'121.0000000newline='\n'119.0000000newline='\n'147.0000000newline='\n'128.0000000newline='\n'133.0000000newline='\n'105.0000000newline='\n'95.0000000newline='\n'104.0000000newline='\n'79.0000000newline='\n'78.0000000
40.0000000newline='\n'29.0000000newline='\n'30.0000000newline='\n'21.0000000newline='\n'18.0000000newline='\n'13.0000000newline='\n'18.0000000newline='\n'25.0000000newline='\n'55.0000000newline='\n'92.0000000newline='\n'97.0000000newline='\n'114.0000000newline='\n'114.0000000newline='\n'112.0000000newline='\n'113.0000000newline='\n'132.0000000newline='\n'159.0000000newline='\n'121.0000000newline='\n'151.0000000newline='\n'131.0000000newline='\n'129.0000000newline='\n'101.0000000newline='\n'87.0000000newline='\n'70.0000000
46.0000000newline='\n'28.0000000newline='\n'27.0000000newline='\n'15.0000000newline='\n'12.0000000newline='\n'13.0000000newline='\n'17.0000000newline='\n'30.0000000newline='\n'58.0000000newline='\n'88.0000000newline='\n'102.0000000newline='\n'113.0000000newline='\n'116.0000000newline='\n'104.0000000newline='\n'118.0000000newline='\n'123.0000000newline='\n'144.0000000newline='\n'123.0000000newline='\n'143.0000000newline='\n'123.0000000newline='\n'121.0000000newline='\n'102.0000000newline='\n'88.0000000newline='\n'72.0000000
50.0000000newline='\n'33.0000000newline='\n'24.0000000newline='\n'12.0000000newline='\n'13.0000000newline='\n'13.0000000newline='\n'19.0000000newline='\n'23.0000000newline='\n'65.0000000newline='\n'80.0000000newline='\n'98.0000000newline='\n'98.0000000newline='\n'85.0000000newline='\n'106.0000000newline='\n'123.0000000newline='\n'101.0000000newline='\n'122.0000000newline='\n'127.0000000newline='\n'92.0000000newline='\n'88.0000000newline='\n'94.0000000newline='\n'96.0000000newline='\n'88.0000000newline='\n'63.0000000
44.0000000newline='\n'26.0000000newline='\n'13.0000000newline='\n'11.0000000newline='\n'14.0000000newline='\n'12.0000000newline='\n'18.0000000newline='\n'27.0000000newline='\n'51.0000000newline='\n'67.0000000newline='\n'102.0000000newline='\n'91.0000000newline='\n'84.0000000newline='\n'102.0000000newline='\n'107.0000000newline='\n'91.0000000newline='\n'112.0000000newline='\n'99.0000000newline='\n'89.0000000newline='\n'88.0000000newline='\n'85.0000000newline='\n'64.0000000newline='\n'77.0000000newline='\n'51.0000000
48.0000000newline='\n'29.0000000newline='\n'23.0000000newline='\n'15.0000000newline='\n'8.0000000newline='\n'14.0000000newline='\n'20.0000000newline='\n'27.0000000newline='\n'56.0000000newline='\n'87.0000000newline='\n'116.0000000newline='\n'106.0000000newline='\n'117.0000000newline='\n'121.0000000newline='\n'121.0000000newline='\n'125.0000000newline='\n'141.0000000newline='\n'129.0000000newline='\n'141.0000000newline='\n'114.0000000newline='\n'92.0000000newline='\n'102.0000000newline='\n'86.0000000newline='\n'71.0000000
52.0000000newline='\n'42.0000000newline='\n'21.0000000newline='\n'19.0000000newline='\n'12.0000000newline='\n'10.0000000newline='\n'18.0000000newline='\n'25.0000000newline='\n'56.0000000newline='\n'95.0000000newline='\n'109.0000000newline='\n'112.0000000newline='\n'106.0000000newline='\n'117.0000000newline='\n'113.0000000newline='\n'123.0000000newline='\n'140.0000000newline='\n'138.0000000newline='\n'139.0000000newline='\n'109.0000000newline='\n'88.0000000newline='\n'95.0000000newline='\n'78.0000000newline='\n'83.0000000
44.0000000newline='\n'30.0000000newline='\n'28.0000000newline='\n'20.0000000newline='\n'15.0000000newline='\n'12.0000000newline='\n'19.0000000newline='\n'23.0000000newline='\n'53.0000000newline='\n'89.0000000newline='\n'98.0000000newline='\n'114.0000000newline='\n'107.0000000newline='\n'107.0000000newline='\n'114.0000000newline='\n'129.0000000newline='\n'153.0000000newline='\n'131.0000000newline='\n'157.0000000newline='\n'134.0000000newline='\n'125.0000000newline='\n'98.0000000newline='\n'78.0000000newline='\n'73.0000000
45.0000000newline='\n'30.0000000newline='\n'24.0000000newline='\n'20.0000000newline='\n'13.0000000newline='\n'11.0000000newline='\n'14.0000000newline='\n'19.0000000newline='\n'45.0000000newline='\n'59.0000000newline='\n'94.0000000newline='\n'87.0000000newline='\n'115.0000000newline='\n'117.0000000newline='\n'109.0000000newline='\n'120.0000000newline='\n'129.0000000newline='\n'121.0000000newline='\n'114.0000000newline='\n'109.0000000newline='\n'87.0000000newline='\n'74.0000000newline='\n'72.0000000newline='\n'54.0000000
48.0000000newline='\n'31.0000000newline='\n'24.0000000newline='\n'16.0000000newline='\n'10.0000000newline='\n'11.0000000newline='\n'17.0000000newline='\n'14.0000000newline='\n'31.0000000newline='\n'52.0000000newline='\n'72.0000000newline='\n'89.0000000newline='\n'89.0000000newline='\n'106.0000000newline='\n'122.0000000newline='\n'129.0000000newline='\n'129.0000000newline='\n'122.0000000newline='\n'126.0000000newline='\n'116.0000000newline='\n'104.0000000newline='\n'88.0000000newline='\n'78.0000000newline='\n'53.0000000
48.0000000newline='\n'44.0000000newline='\n'23.0000000newline='\n'18.0000000newline='\n'24.0000000newline='\n'22.0000000newline='\n'25.0000000newline='\n'24.0000000newline='\n'55.0000000newline='\n'87.0000000newline='\n'103.0000000newline='\n'107.0000000newline='\n'99.0000000newline='\n'96.0000000newline='\n'127.0000000newline='\n'103.0000000newline='\n'140.0000000newline='\n'116.0000000newline='\n'98.0000000newline='\n'87.0000000newline='\n'89.0000000newline='\n'69.0000000newline='\n'73.0000000newline='\n'56.0000000
43.0000000newline='\n'28.0000000newline='\n'18.0000000newline='\n'14.0000000newline='\n'10.0000000newline='\n'16.0000000newline='\n'14.0000000newline='\n'31.0000000newline='\n'57.0000000newline='\n'93.0000000newline='\n'113.0000000newline='\n'110.0000000newline='\n'123.0000000newline='\n'127.0000000newline='\n'120.0000000newline='\n'134.0000000newline='\n'135.0000000newline='\n'128.0000000newline='\n'115.0000000newline='\n'102.0000000newline='\n'80.0000000newline='\n'78.0000000newline='\n'80.0000000newline='\n'54.0000000
44.0000000newline='\n'27.0000000newline='\n'28.0000000newline='\n'14.0000000newline='\n'13.0000000newline='\n'11.0000000newline='\n'16.0000000newline='\n'32.0000000newline='\n'53.0000000newline='\n'87.0000000newline='\n'98.0000000newline='\n'112.0000000newline='\n'111.0000000newline='\n'109.0000000newline='\n'113.0000000newline='\n'127.0000000newline='\n'142.0000000newline='\n'123.0000000newline='\n'133.0000000newline='\n'99.0000000newline='\n'111.0000000newline='\n'97.0000000newline='\n'86.0000000newline='\n'71.0000000
53.0000000newline='\n'34.0000000newline='\n'21.0000000newline='\n'17.0000000newline='\n'11.0000000newline='\n'13.0000000newline='\n'16.0000000newline='\n'27.0000000newline='\n'56.0000000newline='\n'95.0000000newline='\n'125.0000000newline='\n'120.0000000newline='\n'115.0000000newline='\n'119.0000000newline='\n'122.0000000newline='\n'136.0000000newline='\n'150.0000000newline='\n'141.0000000newline='\n'141.0000000newline='\n'109.0000000newline='\n'92.0000000newline='\n'99.0000000newline='\n'85.0000000newline='\n'82.0000000
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             import tensorflow as tf
from keras import backend as K
from tensorflow.keras.losses import Loss

class custom_loss:
    seasonality=1

    def __init__(self, seasonality):
        self.seasonality=seasonality
        K.print_tensor(self.seasonality,message='\nseasonality==')

    @tf.function
    def mase(self, y_true, y_pred, seasonality=1):
        import math
        """
            Mean Absolute Scaled Error
            seasonality가 1이면 비계절성
            seasonality는 마치, window처럼, 각 값을 seasonality 만큼 점프 뛰어가면서, 실제값의 트렌드 오차를 계산하게 된다.
            -- 최종 공식 --
                비계절성 : 평균(절대값(|y 현재 예측 - 현재 실제)) / 평균(절대값(다음것 실제 - 현재 실제))
                계절성 : 평균(절대값(y 현재 예측 - 현재 실제)) / 평균(절대값(다음 window 실제 - 현재 window 실제))
            평균에 절대값의 오차빼기는 mae와 같으므로, mae를 활용했다.
        """
        def _naive_forecasting(actual, seasonality: int = 1):
            """
                Seasonal Naive Approach
                현재 실제값의 window nd.array index가 된다.
                예시) 12시간 중, 3시간씩 규칙성이 있다고 생각된다면, seasonality는 3이다.
                    그럼 1시와 4시, 2시와 5시, 3시와 6시, 4시와 7시로 3시간씩을 떼어가며 실제값의 시즌패턴을 조정하게 된다.
                seasonality가 1인경우, 그냥 앞뒤값만 비교하게 되므로, 비계절성과 똑같다.

                참고) seasonality를 사용하므로, 매 시즌별 패턴이 학습 가능하나, 배치에서 잘리는 등의 이유로 값이 1개가 나오면, 시즌 비교가 불가능해지니, nan으로 학습된다.
                결국 batch로 나누는 학습 수에 따라 학습율이 달라질 수 있는 알고리즘으로 판단됨.

                한 기준의 학습단위로 자른다. (행단위.)
            """
            return actual[:-seasonality]

        def _error(actual, predicted):
            """ 실제값-예측값 """
            return actual - predicted

        def _mae(actual, predicted):
            return K.mean(K.abs(_error(actual, predicted)))

        # K.print_tensor(y_true[:,:,:],message='\ny_true==')
        # K.print_tensor(y_true.shape,message='\ny_true shape==')
        # K.print_tensor(y_pred[:,:,:],message='\ny_pred==')
        # K.print_tensor(y_pred.shape,message='\ny_pred shape==')
    #     K.print_tensor(_mae(y_true[seasonality:], _naive_forecasting(y_true, seasonality)),message='\n분모==')
    #     print(y_true.shape, y_pred.shape)
        seasonality = self.seasonality
        
        # K.print_tensor(y_true[:,:,0:1],message='\ny_first==')
        # K.print_tensor(y_true[:,:,1:2],message='\ny_sec==')
        denominator = _mae(y_true[:,:,0:1],y_true[:,:,1:2])

#         K.print_tensor(_mae(y_true, y_pred),message='\n분자==')
        # K.print_tensor(denominator,message='\n분모==')

        if denominator == 0 or tf.math.is_nan(denominator):
            # 실제 값의 앞뒤가 똑같은경우, 분모가 0이되어버린다. (전후시간의 갭이 없음.)
            # 값이 홀수개가 들어와 미래의 값과 비교할 것이 없는 경우, 분모는 nan이 되버린다.
            # 이와같은경우, 분모를 MAE값을 0.111로 설정한다. (그냥 작은 값으로 설정함....)
            K.print_tensor('==================== someting STRANGE HAPPEN!!!!!!!!!!!!!!!!! ================')
            K.print_tensor(y_true,message='\ny_true==')
            K.print_tensor(y_pred,message='\ny_pred==')
            
            K.print_tensor(_mae(y_true[:,:,1:2], y_pred),message='\nChild==')
            K.print_tensor(denominator,message='\nParent==')
            
            return _mae(y_true, y_pred) / 1
        else:
            result = _mae(y_true, y_pred) / denominator
            K.print_tensor(result,message='\nIN_BATCH_LOSS==')
            return result                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 # coding=utf-8
#
# created by kpe on 26.Mar.2019 at 14:11
#

from __future__ import absolute_import, division, print_function

import random

import unittest

import numpy as np
import tensorflow as tf

from tensorflow import keras

from bert import BertModelLayer


tf.compat.v1.enable_eager_execution()


class MaskFlatten(keras.layers.Flatten):

    def __init__(self, **kwargs):
        self.supports_masking = True
        super(MaskFlatten, self).__init__(**kwargs)

    def compute_mask(self, _, mask=None):
        return mask


def parity_ds_generator(batch_size=32, max_len=10, max_int=4, modulus=2):
    """
    Generates a parity calculation dataset (seq -> sum(seq) mod 2),
    where seq is a sequence of length less than max_len
    of integers in [1..max_int).
    """
    while True:
        data = np.zeros((batch_size, max_len))
        tag = np.zeros(batch_size, dtype='int32')
        for i in range(batch_size):
            datum_len = random.randint(1, max_len - 1)
            total = 0
            for j in range(datum_len):
                data[i, j] = random.randint(1, max_int)
                total += data[i, j]
            tag[i] = total % modulus
        yield data, tag                  # ([batch_size, max_len], [max_len])


class RawBertTest(unittest.TestCase):

    def test